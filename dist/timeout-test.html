<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Timeout Tests - Speakeasy</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      padding: 40px;
      max-width: 800px;
      width: 100%;
    }

    h1 {
      color: #333;
      margin-bottom: 10px;
      font-size: 32px;
    }

    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 14px;
    }

    .test-section {
      margin-bottom: 30px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 10px;
      border: 2px solid transparent;
      transition: all 0.3s;
    }

    .test-section.running {
      border-color: #667eea;
      background: #f0f4ff;
    }

    .test-section.success {
      border-color: #10b981;
      background: #f0fdf4;
    }

    .test-section.failed {
      border-color: #ef4444;
      background: #fef2f2;
    }

    h2 {
      color: #333;
      margin-bottom: 15px;
      font-size: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .description {
      color: #666;
      margin-bottom: 15px;
      font-size: 14px;
      line-height: 1.5;
    }

    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 600;
    }

    button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .result {
      margin-top: 15px;
      padding: 15px;
      background: white;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      display: none;
    }

    .result.visible {
      display: block;
    }

    .result.success {
      border-left: 4px solid #10b981;
      color: #059669;
    }

    .result.failed {
      border-left: 4px solid #ef4444;
      color: #dc2626;
    }

    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 3px solid rgba(102, 126, 234, 0.3);
      border-radius: 50%;
      border-top-color: #667eea;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .status-icon {
      font-size: 24px;
    }

    .progress {
      margin-top: 10px;
      height: 4px;
      background: #e5e7eb;
      border-radius: 2px;
      overflow: hidden;
      display: none;
    }

    .progress.visible {
      display: block;
    }

    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      transition: width 0.3s;
    }

    .summary {
      margin-top: 30px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 10px;
      display: none;
    }

    .summary.visible {
      display: block;
    }

    .summary h3 {
      margin-bottom: 15px;
      color: #333;
    }

    .summary-item {
      display: flex;
      justify-content: space-between;
      padding: 10px;
      background: white;
      border-radius: 6px;
      margin-bottom: 8px;
    }

    .summary-item:last-child {
      margin-bottom: 0;
    }

    code {
      background: #f3f4f6;
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
    }

    .info-box {
      background: #eff6ff;
      border: 1px solid #bfdbfe;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 30px;
    }

    .info-box p {
      color: #1e40af;
      font-size: 14px;
      line-height: 1.6;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üß™ Timeout Tests</h1>
    <p class="subtitle">Verify that 30-second timeouts are working correctly for all AI operations</p>

    <div class="info-box">
      <p><strong>What this tests:</strong> The timeout mechanism ensures AI API calls (Bedrock, Deepgram, Gemini) don't hang indefinitely. Each test simulates slow/hanging APIs to verify the 30-second timeout triggers correctly.</p>
    </div>

    <!-- Test 1: Fast API -->
    <div class="test-section" id="test1-section">
      <h2>
        <span class="status-icon" id="test1-icon">‚ö™</span>
        Test 1: Fast API Call
      </h2>
      <p class="description">
        Simulates a fast API response (2 seconds). This should complete successfully within the 30-second timeout.
      </p>
      <button onclick="runTest1()">Run Test 1</button>
      <div class="progress" id="test1-progress">
        <div class="progress-bar" id="test1-progress-bar"></div>
      </div>
      <div class="result" id="test1-result"></div>
    </div>

    <!-- Test 2: Timeout -->
    <div class="test-section" id="test2-section">
      <h2>
        <span class="status-icon" id="test2-icon">‚ö™</span>
        Test 2: Timeout After 30 Seconds
      </h2>
      <p class="description">
        Uses a promise that never resolves (guaranteed to hang). The timeout should trigger after 30 seconds and abort the operation.
      </p>
      <button onclick="runTest2()">Run Test 2 (takes 30s)</button>
      <div class="progress" id="test2-progress">
        <div class="progress-bar" id="test2-progress-bar"></div>
      </div>
      <div class="result" id="test2-result"></div>
    </div>

    <!-- Run All -->
    <div style="text-align: center; margin-top: 30px;">
      <button onclick="runAllTests()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 15px 40px; font-size: 18px;">
        üöÄ Run All Tests (~35 seconds)
      </button>
    </div>

    <!-- Summary -->
    <div class="summary" id="summary">
      <h3>üìä Test Summary</h3>
      <div id="summary-content"></div>
    </div>
  </div>

  <script>
    let test1Result = null;
    let test2Result = null;

    async function runTest1() {
      const section = document.getElementById('test1-section');
      const icon = document.getElementById('test1-icon');
      const resultDiv = document.getElementById('test1-result');
      const progressDiv = document.getElementById('test1-progress');
      const progressBar = document.getElementById('test1-progress-bar');
      const button = section.querySelector('button');

      // Reset
      section.className = 'test-section running';
      icon.innerHTML = '<span class="spinner"></span>';
      resultDiv.className = 'result';
      resultDiv.style.display = 'none';
      progressDiv.className = 'progress visible';
      button.disabled = true;

      const start = Date.now();
      const controller = new AbortController();
      const timeout = setTimeout(() => controller.abort(), 30000);

      // Simulate progress
      const progressInterval = setInterval(() => {
        const elapsed = Date.now() - start;
        const progress = Math.min((elapsed / 3000) * 100, 100);
        progressBar.style.width = progress + '%';
      }, 50);

      try {
        await fetch('https://httpbin.org/delay/2', {
          signal: controller.signal
        }).finally(() => clearTimeout(timeout));

        clearInterval(progressInterval);
        const duration = Date.now() - start;

        // Success
        test1Result = { success: true, duration };
        section.className = 'test-section success';
        icon.textContent = '‚úÖ';
        resultDiv.className = 'result visible success';
        resultDiv.innerHTML = `
          <strong>‚úÖ TEST PASSED</strong><br>
          Fast request completed in ${duration}ms (under 30-second timeout)<br>
          Expected: Success within timeout ‚úì
        `;
        progressBar.style.width = '100%';
      } catch (err) {
        clearInterval(progressInterval);
        const duration = Date.now() - start;

        // Failed
        test1Result = { success: false, error: err.message, duration };
        section.className = 'test-section failed';
        icon.textContent = '‚ùå';
        resultDiv.className = 'result visible failed';
        resultDiv.innerHTML = `
          <strong>‚ùå TEST FAILED</strong><br>
          Error: ${err.message}<br>
          Duration: ${duration}ms<br>
          Expected: Success, but got error
        `;
      } finally {
        button.disabled = false;
        progressDiv.className = 'progress';
      }

      updateSummary();
    }

    async function runTest2() {
      const section = document.getElementById('test2-section');
      const icon = document.getElementById('test2-icon');
      const resultDiv = document.getElementById('test2-result');
      const progressDiv = document.getElementById('test2-progress');
      const progressBar = document.getElementById('test2-progress-bar');
      const button = section.querySelector('button');

      // Reset
      section.className = 'test-section running';
      icon.innerHTML = '<span class="spinner"></span>';
      resultDiv.className = 'result';
      resultDiv.style.display = 'none';
      progressDiv.className = 'progress visible';
      button.disabled = true;

      const start = Date.now();
      const controller = new AbortController();
      const timeout = setTimeout(() => controller.abort(), 30000);

      // Simulate progress up to 30 seconds
      const progressInterval = setInterval(() => {
        const elapsed = Date.now() - start;
        const progress = Math.min((elapsed / 30000) * 100, 100);
        progressBar.style.width = progress + '%';
      }, 50);

      try {
        // Create a promise that NEVER resolves (guaranteed to hang)
        const hangingPromise = new Promise(() => {});

        // Race between hanging promise and a fetch with abort signal
        await Promise.race([
          hangingPromise,
          fetch('data:text/plain,test', { signal: controller.signal })
        ]).finally(() => clearTimeout(timeout));

        clearInterval(progressInterval);

        // Should not reach here
        test2Result = { success: false, message: 'Did not timeout' };
        section.className = 'test-section failed';
        icon.textContent = '‚ùå';
        resultDiv.className = 'result visible failed';
        resultDiv.innerHTML = `
          <strong>‚ùå TEST FAILED</strong><br>
          Promise.race completed without timing out (unexpected)<br>
          Expected: Timeout after 30 seconds
        `;
      } catch (err) {
        clearInterval(progressInterval);
        const duration = Date.now() - start;

        if (err.name === 'AbortError') {
          // Success - timeout worked
          test2Result = { success: true, duration };
          section.className = 'test-section success';
          icon.textContent = '‚úÖ';
          resultDiv.className = 'result visible success';
          resultDiv.innerHTML = `
            <strong>‚úÖ TEST PASSED</strong><br>
            Request timed out after ${duration}ms (expected ~30000ms)<br>
            Variance: ${Math.abs(duration - 30000)}ms<br>
            Expected: Timeout ‚úì
          `;
          progressBar.style.width = '100%';
          progressBar.style.background = '#10b981';
        } else {
          // Wrong error type
          test2Result = { success: false, error: err.message, duration };
          section.className = 'test-section failed';
          icon.textContent = '‚ùå';
          resultDiv.className = 'result visible failed';
          resultDiv.innerHTML = `
            <strong>‚ùå TEST FAILED</strong><br>
            Wrong error type: ${err.message}<br>
            Duration: ${duration}ms<br>
            Expected: AbortError, got ${err.name}
          `;
        }
      } finally {
        button.disabled = false;
        progressDiv.className = 'progress';
      }

      updateSummary();
    }

    async function runAllTests() {
      console.log('Running all tests...');
      await runTest1();
      await new Promise(resolve => setTimeout(resolve, 1000));
      await runTest2();
    }

    function updateSummary() {
      if (!test1Result && !test2Result) return;

      const summaryDiv = document.getElementById('summary');
      const summaryContent = document.getElementById('summary-content');
      summaryDiv.className = 'summary visible';

      let html = '';

      if (test1Result) {
        html += `
          <div class="summary-item">
            <span>${test1Result.success ? '‚úÖ' : '‚ùå'} Test 1: Fast API Call</span>
            <span><strong>${test1Result.success ? 'PASS' : 'FAIL'}</strong> (${test1Result.duration}ms)</span>
          </div>
        `;
      }

      if (test2Result) {
        html += `
          <div class="summary-item">
            <span>${test2Result.success ? '‚úÖ' : '‚ùå'} Test 2: Timeout After 30s</span>
            <span><strong>${test2Result.success ? 'PASS' : 'FAIL'}</strong> (${test2Result.duration}ms)</span>
          </div>
        `;
      }

      if (test1Result && test2Result) {
        const allPassed = test1Result.success && test2Result.success;
        html += `
          <div class="summary-item" style="background: ${allPassed ? '#f0fdf4' : '#fef2f2'}; font-weight: bold;">
            <span>${allPassed ? 'üéâ' : '‚ö†Ô∏è'} Overall Result</span>
            <span>${allPassed ? 'ALL TESTS PASSED' : 'SOME TESTS FAILED'}</span>
          </div>
        `;
      }

      summaryContent.innerHTML = html;
    }
  </script>
</body>
</html>
