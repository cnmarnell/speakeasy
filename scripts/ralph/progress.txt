# Ralph Progress Log
Started: Sun Jan 11 09:26:49 EST 2026

## Codebase Patterns
- Migrations use SQL files in supabase/migrations/ with YYYYMMDDHHMMSS_ prefix
- Use `IF NOT EXISTS` for CREATE TABLE/INDEX statements
- Enable RLS on new tables and add appropriate policies
- Build passes even with pre-existing lint errors in test files
- Edge functions in supabase/functions/ use Deno.serve() with manual HTTP method routing
- Import Supabase client in Edge Functions: `import { createClient } from "https://esm.sh/@supabase/supabase-js@2"`
- Shared modules for Edge Functions go in supabase/functions/_shared/ directory
- App uses state-based routing via `currentView` state in App.jsx (not react-router)
- TeacherDashboard and other pages receive navigation callbacks as props (onViewRubrics, onBack, etc.)
- Call Edge Functions from frontend using `supabase.functions.invoke('function-name', { method: 'GET' })`
- Use theatrical/speakeasy CSS design: maroon (#8B1538), gold (#D4AF37), cream (#FFF8E7) colors
- CSS files are component-specific (e.g., RubricsPage.css for RubricsPage.jsx)
---

## 2026-01-11 09:27 - US-001
Thread: https://ampcode.com/threads/T-019bad73-dd14-7599-9a0c-b32f872c1ccb
- Implemented rubrics and rubric_criteria tables migration
- Files changed: supabase/migrations/20260111092739_create_rubrics_tables.sql
- **Learnings for future iterations:**
  - Supabase migrations use plain SQL files with timestamp prefixes
  - Teachers table is referenced as `teachers(id)` for foreign keys
  - RLS policies need to be enabled and configured for each table
  - Use CASCADE on foreign keys for criteria -> rubric relationship
  - Column named "order" needs quotes because it's a reserved keyword
---

## 2026-01-11 09:29 - US-002
Thread: https://ampcode.com/threads/T-019bad75-c5d4-7082-9872-7c77d057ed28
- Created seed migration for CAR Framework rubric with 4 criteria
- Files changed: supabase/migrations/20260111092930_seed_car_rubric.sql
- **Learnings for future iterations:**
  - Use DO $$ blocks with PL/pgSQL for complex seed logic
  - Use fixed UUIDs and ON CONFLICT DO NOTHING for idempotent seeding
  - created_by can be NULL for system-created resources
  - Escape single quotes in SQL strings with double single quotes ('')
---

## 2026-01-11 09:31 - US-003
Thread: https://ampcode.com/threads/T-019bad77-3c2c-73b8-afbf-e0d932c90e90
- Created evaluations and evaluation_scores tables migration
- Files changed: supabase/migrations/20260111093132_create_evaluations_tables.sql
- **Learnings for future iterations:**
  - evaluations table uses is_fallback boolean and raw_response for handling unparseable LLM responses
  - Both tables CASCADE delete from parent records (student/rubric for evaluations, evaluation/criterion for scores)
  - Added indexes for common query patterns (student_id, rubric_id, created_at DESC)
---

## 2026-01-11 09:33 - US-004
Thread: https://ampcode.com/threads/T-019bad79-68ff-760c-9dbb-f81e4012ac54
- Added rubric_id nullable FK column to assignments table
- Files changed: supabase/migrations/20260111093333_add_rubric_id_to_assignments.sql
- **Learnings for future iterations:**
  - Use ON DELETE SET NULL for optional FK relationships (allows rubric deletion without breaking assignments)
  - ALTER TABLE ADD COLUMN IF NOT EXISTS is idempotent
---

## 2026-01-11 09:45 - US-005
Thread: https://ampcode.com/threads/T-019bad7a-c23f-7673-a0e9-0700d1f65ab7
- Created rubrics CRUD API Edge Function with all endpoints: GET (list/single), POST, PUT, DELETE
- Files changed: supabase/functions/rubrics/index.ts
- **Learnings for future iterations:**
  - Supabase Edge Functions use `Deno.serve()` pattern with manual method routing
  - Use `createClient` from `https://esm.sh/@supabase/supabase-js@2` for Deno
  - CORS headers must be set on all responses and OPTIONS must return early
  - Get user from auth token via `supabase.auth.getUser(token)`, then look up teacher by email
  - For PUT operations: delete all criteria and re-insert (full replacement) for simplicity
  - Validate rubric must have ≥1 criterion and each criterion max_points ≥1
---

## 2026-01-11 09:40 - US-006
Thread: https://ampcode.com/threads/T-019bad7e-2d7e-705b-a7b5-0b6da4ba0f26
- Created structured evaluation prompt template module
- Files changed: supabase/functions/_shared/evaluationPrompt.ts
- **Learnings for future iterations:**
  - Shared modules for Edge Functions go in supabase/functions/_shared/
  - Export TypeScript interfaces for types shared between Edge Functions
  - buildEvaluationPrompt() accepts rubricName, criteria[], transcript and returns a formatted prompt
  - parseEvaluationResponse() handles JSON parsing with fallback cleanup for markdown fences
  - Prompt explicitly instructs LLM to return ONLY valid JSON with exact schema
  - Include partial points instruction and "do not teach or rewrite" guidance
---

## 2026-01-11 10:15 - US-007
Thread: https://ampcode.com/threads/T-019bad81-2469-7610-aea3-2b63a754b9ee
- Created POST /api/evaluate Edge Function that calls Claude via AWS Bedrock
- Files changed: supabase/functions/evaluate/index.ts
- **Learnings for future iterations:**
  - Import shared modules with relative path: `from "../_shared/evaluationPrompt.ts"`
  - AWS Signature V4 code can be duplicated per-function (no shared utils for crypto helpers)
  - Use Claude 3 Haiku for evaluations: `anthropic.claude-3-haiku-20240307-v1:0/invoke`
  - temperature 0.3 keeps JSON output more consistent
  - dry_run parameter skips database storage for calibration/testing
  - Handle fallback mode: if JSON parse fails, store raw_response and set is_fallback=true
  - student_id is optional; can be null for dry_run/calibration calls
---

## 2026-01-11 10:30 - US-008
Thread: https://ampcode.com/threads/T-019bad90-385f-733d-9a10-c72e58868a31
- RubricsPage implementation was already present (verified and marked as passing)
- Files changed: src/components/RubricsPage.jsx, src/components/RubricsPage.css
- **Learnings for future iterations:**
  - RubricsPage uses supabase.functions.invoke('rubrics') for API calls
  - Cards display rubric name, description, criteria count, created date, and max points
  - Edit/Delete action buttons included on each card
  - Navigation uses onBack, onEditRubric, onCreateRubric callback props
---

## 2026-01-11 10:35 - US-009
Thread: https://ampcode.com/threads/T-019bad90-385f-733d-9a10-c72e58868a31
- Created RubricFormPage component for create/edit rubrics
- Files changed: src/components/RubricFormPage.jsx, src/components/RubricFormPage.css, src/App.jsx
- **Learnings for future iterations:**
  - Form uses isEditing boolean to switch between create/edit modes
  - Criteria are stored in state array with temp IDs for new criteria
  - handleCriterionChange() updates individual criterion fields
  - handleAddCriterion() appends with order = criteria.length
  - handleRemoveCriterion() reorders remaining criteria after removal
  - API calls: POST rubrics (create) or PUT rubrics/:id (update)
  - Form validation: name required, min 1 criterion, each criterion needs name and max_points >= 1
---

## 2026-01-11 - US-010
Thread: https://ampcode.com/threads/T-019bad92-51ca-71a8-bfcb-8c6b73c33a27
- Verified edit rubric form functionality (already implemented in previous iterations)
- Edit button on RubricsPage opens RubricFormPage pre-populated with rubric data
- Criteria array is populated from rubric.criteria in useState initializer
- Add/remove criteria functionality works with handleAddCriterion and handleRemoveCriterion
- Save calls PUT API with rubric ID, shows success/error alerts
- Files verified: src/components/RubricFormPage.jsx, src/components/RubricsPage.jsx, src/App.jsx
- **Learnings for future iterations:**
  - RubricFormPage uses `isEditing = !!rubric` pattern to detect edit mode
  - Form pre-population happens in useState initializers with rubric prop
  - App.jsx uses selectedRubric state to pass rubric data between pages
---

## 2026-01-11 - US-011
Thread: https://ampcode.com/threads/T-019bad94-2430-7507-8a28-376c1134b210
- Added up/down reordering buttons to criterion rows in RubricFormPage
- Implemented handleMoveCriterionUp and handleMoveCriterionDown functions
- Added CSS styles for reorder buttons with theatrical gold/maroon theme
- Files changed: src/components/RubricFormPage.jsx, src/components/RubricFormPage.css
- **Learnings for future iterations:**
  - Reorder by swapping array positions and updating order property on both items
  - Use early return guard (index === 0 or index === length-1) to prevent out-of-bounds
  - Buttons disabled at boundaries with appropriate disabled state styling
  - Order persists to DB via array index in handleSubmit's criteria.map((c, idx) => ({ order: idx }))
---

## 2026-01-11 - US-012
Thread: https://ampcode.com/threads/T-019bad96-d39c-7159-85ba-75a1cdeefd83
- Added rubric dropdown to NewAssignmentModal for selecting evaluation rubrics
- ClassPage fetches professor's rubrics via supabase.functions.invoke('rubrics')
- createAssignment now saves rubric_id to assignments table
- Files changed: src/components/NewAssignmentModal.jsx, src/components/ClassPage.jsx, src/data/supabaseData.js
- **Learnings for future iterations:**
  - NewAssignmentModal receives rubrics as a prop (array of rubric objects with criteria)
  - Dropdown shows rubric name with criteria count and total points for easy selection
  - rubricId is optional - empty string means no rubric, converted to null on save
  - ClassPage already imports supabase directly for functions.invoke calls
---

## 2026-01-11 - US-013
Thread: https://ampcode.com/threads/T-019bad99-e199-77df-ab76-e9dff593a10d
- Created StudentEvaluationCard component for displaying rubric-based evaluation results
- Features: circular score display with SVG ring, color-coded criteria rows (green/yellow/red), progress bars
- Integrated into Results.jsx - fetches evaluation data from evaluations + evaluation_scores tables
- Added fallback display for when structured grading fails (shows raw_response)
- Files changed: src/components/StudentEvaluationCard.jsx, src/components/StudentEvaluationCard.css, src/components/Results.jsx
- **Learnings for future iterations:**
  - StudentEvaluationCard expects evaluation object with criteria_scores array, total_score, max_total_score, overall_feedback, improvement_suggestions, fallback, raw_response
  - Color coding uses getScoreColor() helper: ratio >= 1 = green, ratio >= 0.5 = yellow, ratio < 0.5 = red
  - Fetch evaluation_scores with rubric_criteria join to get criterion names
  - Results.jsx queries evaluations by student_id with latest first (order by created_at DESC, limit 1)
---

## 2026-01-11 - US-014
Thread: https://ampcode.com/threads/T-019bad9e-7723-728f-acae-e1f26287571b
- Verified fallback display functionality was already implemented in US-013
- StudentEvaluationCard.jsx lines 31-48 handle fallback mode: warning banner, raw_response display, early return
- Results.jsx lines 142-150 correctly map is_fallback to fallback prop and pass raw_response
- Build passes successfully
- Files verified: src/components/StudentEvaluationCard.jsx, src/components/Results.jsx
- **Learnings for future iterations:**
  - Fallback handling was bundled with StudentEvaluationCard creation (good pattern for atomic features)
  - CSS for fallback (.fallback-warning, .raw-response-text) already styled with theatrical theme
---

## 2026-01-11 - US-015
Thread: https://ampcode.com/threads/T-019bada0-d4b9-7151-8b85-a777b3cd67ed
- Created RubricCalibrationModal component for testing rubrics against sample transcripts
- Added "Test Rubric" button to RubricFormPage header (visible only in edit mode)
- Modal includes: large transcript textarea, Run Evaluation button, Clear Results button
- Calls /api/evaluate with dry_run: true to prevent database storage
- Displays results using StudentEvaluationCard (same format as student view)
- Files changed: src/components/RubricCalibrationModal.jsx, src/components/RubricCalibrationModal.css, src/components/RubricFormPage.jsx, src/components/RubricFormPage.css
- **Learnings for future iterations:**
  - Use dry_run: true parameter for calibration/test evaluations to skip database storage
  - Modal overlay uses onClick={onClose} with e.stopPropagation() on inner content to close on outside click
  - Reuse StudentEvaluationCard for consistent evaluation display across contexts
  - Test Rubric button uses green color scheme (#22c55e) to distinguish from primary maroon actions
---
