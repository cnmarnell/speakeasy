# Ralph Progress Log
Started: Sun Jan 11 09:26:49 EST 2026

## Codebase Patterns
- Migrations use SQL files in supabase/migrations/ with YYYYMMDDHHMMSS_ prefix
- Use `IF NOT EXISTS` for CREATE TABLE/INDEX statements
- Enable RLS on new tables and add appropriate policies
- Build passes even with pre-existing lint errors in test files
- Edge functions in supabase/functions/ use Deno.serve() with manual HTTP method routing
- Import Supabase client in Edge Functions: `import { createClient } from "https://esm.sh/@supabase/supabase-js@2"`
- Shared modules for Edge Functions go in supabase/functions/_shared/ directory
---

## 2026-01-11 09:27 - US-001
Thread: https://ampcode.com/threads/T-019bad73-dd14-7599-9a0c-b32f872c1ccb
- Implemented rubrics and rubric_criteria tables migration
- Files changed: supabase/migrations/20260111092739_create_rubrics_tables.sql
- **Learnings for future iterations:**
  - Supabase migrations use plain SQL files with timestamp prefixes
  - Teachers table is referenced as `teachers(id)` for foreign keys
  - RLS policies need to be enabled and configured for each table
  - Use CASCADE on foreign keys for criteria -> rubric relationship
  - Column named "order" needs quotes because it's a reserved keyword
---

## 2026-01-11 09:29 - US-002
Thread: https://ampcode.com/threads/T-019bad75-c5d4-7082-9872-7c77d057ed28
- Created seed migration for CAR Framework rubric with 4 criteria
- Files changed: supabase/migrations/20260111092930_seed_car_rubric.sql
- **Learnings for future iterations:**
  - Use DO $$ blocks with PL/pgSQL for complex seed logic
  - Use fixed UUIDs and ON CONFLICT DO NOTHING for idempotent seeding
  - created_by can be NULL for system-created resources
  - Escape single quotes in SQL strings with double single quotes ('')
---

## 2026-01-11 09:31 - US-003
Thread: https://ampcode.com/threads/T-019bad77-3c2c-73b8-afbf-e0d932c90e90
- Created evaluations and evaluation_scores tables migration
- Files changed: supabase/migrations/20260111093132_create_evaluations_tables.sql
- **Learnings for future iterations:**
  - evaluations table uses is_fallback boolean and raw_response for handling unparseable LLM responses
  - Both tables CASCADE delete from parent records (student/rubric for evaluations, evaluation/criterion for scores)
  - Added indexes for common query patterns (student_id, rubric_id, created_at DESC)
---

## 2026-01-11 09:33 - US-004
Thread: https://ampcode.com/threads/T-019bad79-68ff-760c-9dbb-f81e4012ac54
- Added rubric_id nullable FK column to assignments table
- Files changed: supabase/migrations/20260111093333_add_rubric_id_to_assignments.sql
- **Learnings for future iterations:**
  - Use ON DELETE SET NULL for optional FK relationships (allows rubric deletion without breaking assignments)
  - ALTER TABLE ADD COLUMN IF NOT EXISTS is idempotent
---

## 2026-01-11 09:45 - US-005
Thread: https://ampcode.com/threads/T-019bad7a-c23f-7673-a0e9-0700d1f65ab7
- Created rubrics CRUD API Edge Function with all endpoints: GET (list/single), POST, PUT, DELETE
- Files changed: supabase/functions/rubrics/index.ts
- **Learnings for future iterations:**
  - Supabase Edge Functions use `Deno.serve()` pattern with manual method routing
  - Use `createClient` from `https://esm.sh/@supabase/supabase-js@2` for Deno
  - CORS headers must be set on all responses and OPTIONS must return early
  - Get user from auth token via `supabase.auth.getUser(token)`, then look up teacher by email
  - For PUT operations: delete all criteria and re-insert (full replacement) for simplicity
  - Validate rubric must have ≥1 criterion and each criterion max_points ≥1
---

## 2026-01-11 09:40 - US-006
Thread: https://ampcode.com/threads/T-019bad7e-2d7e-705b-a7b5-0b6da4ba0f26
- Created structured evaluation prompt template module
- Files changed: supabase/functions/_shared/evaluationPrompt.ts
- **Learnings for future iterations:**
  - Shared modules for Edge Functions go in supabase/functions/_shared/
  - Export TypeScript interfaces for types shared between Edge Functions
  - buildEvaluationPrompt() accepts rubricName, criteria[], transcript and returns a formatted prompt
  - parseEvaluationResponse() handles JSON parsing with fallback cleanup for markdown fences
  - Prompt explicitly instructs LLM to return ONLY valid JSON with exact schema
  - Include partial points instruction and "do not teach or rewrite" guidance
---
