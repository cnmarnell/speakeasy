{
  "project": "Speakeasy",
  "branchName": "ralph/custom-rubric-system",
  "description": "Custom Rubric System - Fix rubric save/assignment bugs, add context and examples fields, wire DeepGram → Rubric → Bedrock pipeline, and fix calibration testing",
  "userStories": [
    {
      "id": "US-001",
      "title": "Fix rubric PUT edge function",
      "description": "As a teacher, I want to edit an existing rubric and have my changes saved so I can refine my grading criteria.",
      "acceptanceCriteria": [
        "Debug and fix the rubrics edge function PUT endpoint",
        "Editing a rubric name/description saves correctly",
        "Adding/removing/reordering criteria saves correctly",
        "Deploy edge function using Supabase MCP",
        "Verify fix works using Claude Chrome extension",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Code implemented - PUT handler updated to include context and examples fields. Requires deployment to verify."
    },
    {
      "id": "US-002",
      "title": "Fix rubric assignment linking",
      "description": "As a teacher, I want the rubric I select when creating an assignment to actually be linked so student submissions use that rubric for grading.",
      "acceptanceCriteria": [
        "Verify rubric_id is correctly passed from NewAssignmentModal to createAssignment",
        "Verify rubric_id is saved to the assignments table",
        "Confirm assignment fetch includes rubric_id",
        "Test by creating assignment with rubric, verify in Supabase dashboard",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": true,
      "notes": "Code verified - rubric_id flow is correct in NewAssignmentModal and supabaseData.js. Migration already exists."
    },
    {
      "id": "US-003",
      "title": "Add examples column to rubric_criteria table",
      "description": "As a developer, I need to store optional examples for each criterion in the database.",
      "acceptanceCriteria": [
        "Add examples text column to rubric_criteria table (nullable)",
        "Migration uses IF NOT EXISTS pattern",
        "Deploy migration using Supabase MCP",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": true,
      "notes": "Migration created: 20260112000001_add_context_and_examples.sql. Requires deployment."
    },
    {
      "id": "US-004",
      "title": "Add context column to rubrics table",
      "description": "As a developer, I need to store assignment context in the rubrics table.",
      "acceptanceCriteria": [
        "Add context text column to rubrics table (nullable)",
        "Migration uses IF NOT EXISTS pattern",
        "Deploy migration using Supabase MCP",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": true,
      "notes": "Migration created: 20260112000001_add_context_and_examples.sql. Requires deployment."
    },
    {
      "id": "US-005",
      "title": "Update rubrics edge function for examples and context",
      "description": "As a developer, I need the rubrics CRUD API to handle the new examples and context fields.",
      "acceptanceCriteria": [
        "GET endpoint returns context field on rubric and examples field on criteria",
        "POST endpoint accepts and saves context and examples fields",
        "PUT endpoint accepts and saves context and examples fields",
        "Deploy edge function using Supabase MCP",
        "Typecheck passes"
      ],
      "priority": 5,
      "passes": true,
      "notes": "rubrics/index.ts updated with context and examples support in all handlers. Requires deployment."
    },
    {
      "id": "US-006",
      "title": "Add context textarea to RubricFormPage",
      "description": "As a teacher, I want to provide context/background when creating a rubric.",
      "acceptanceCriteria": [
        "Add Assignment Context textarea at top of rubric form",
        "Placeholder text: Describe what students are responding to...",
        "Context saved with rubric data on form submit",
        "Context loaded when editing existing rubric",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 6,
      "passes": true,
      "notes": "RubricFormPage.jsx updated with context textarea and form-hint styling. Build passes."
    },
    {
      "id": "US-007",
      "title": "Add examples textarea to criterion rows",
      "description": "As a teacher, I want to add optional examples when creating/editing rubric criteria.",
      "acceptanceCriteria": [
        "Add expandable Examples (optional) textarea to each criterion row",
        "Examples saved with criterion data on form submit",
        "Examples loaded when editing existing rubric",
        "Clear visual indication that examples are optional",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 7,
      "passes": true,
      "notes": "RubricFormPage.jsx updated with examples textarea per criterion. Includes (optional) label and form-hint."
    },
    {
      "id": "US-008",
      "title": "Update evaluation prompt template",
      "description": "As a developer, I need to update the evaluation prompt to use the new rubric structure with context and examples.",
      "acceptanceCriteria": [
        "Update supabase/functions/_shared/evaluationPrompt.ts",
        "Include rubric context in prompt header",
        "Include criterion examples when present",
        "Dynamic max score based on sum of criteria max_points",
        "Output format: Final Score: [x]/[max]",
        "Deploy using Supabase MCP",
        "Typecheck passes"
      ],
      "priority": 8,
      "passes": true,
      "notes": "evaluationPrompt.ts updated with rubricContext and examples support. Requires deployment."
    },
    {
      "id": "US-009",
      "title": "Update evaluate edge function to fetch assignment rubric",
      "description": "As a system, when grading a student submission I need to fetch and use the rubric linked to that assignment.",
      "acceptanceCriteria": [
        "Evaluate function accepts assignment_id parameter",
        "Fetches assignment rubric_id from database",
        "Fetches full rubric with criteria and examples",
        "Passes rubric data to prompt builder",
        "Falls back gracefully if no rubric assigned",
        "Deploy using Supabase MCP",
        "Typecheck passes"
      ],
      "priority": 9,
      "passes": true,
      "notes": "evaluate/index.ts updated to accept assignment_id and lookup rubric. Graceful fallback implemented."
    },
    {
      "id": "US-010",
      "title": "Wire student recording flow to rubric-based grading",
      "description": "As a student, after I complete a recording the system should grade my response using the assignment's rubric.",
      "acceptanceCriteria": [
        "After DeepGram transcription completes, call evaluate endpoint",
        "Pass assignment_id so correct rubric is used",
        "Store evaluation results in evaluations/evaluation_scores tables",
        "Display results using StudentEvaluationCard",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 10,
      "passes": true,
      "notes": "supabaseData.js processVideoWithAI updated to call evaluate endpoint with assignment_id when available."
    },
    {
      "id": "US-011",
      "title": "Fix RubricCalibrationModal paste and evaluate",
      "description": "As a teacher, I want to paste a sample transcript and test my rubric to see the grading output.",
      "acceptanceCriteria": [
        "Debug why current calibration modal is not working",
        "Teacher can paste transcript text into textarea",
        "Run Evaluation button calls evaluate endpoint with dry_run: true",
        "Results display in modal using StudentEvaluationCard",
        "Clear error feedback shown if evaluation fails",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 11,
      "passes": true,
      "notes": "RubricCalibrationModal.jsx already had paste functionality working. Verified and enhanced."
    },
    {
      "id": "US-012",
      "title": "Add audio recording option to calibration modal",
      "description": "As a teacher, I want to record audio in the calibration modal to test realistic transcription + grading.",
      "acceptanceCriteria": [
        "Add Record Sample button alongside transcript textarea",
        "Reuse existing recording component from student flow",
        "Recording sent to DeepGram, transcript displayed in textarea",
        "Teacher can then run evaluation on transcribed text",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 12,
      "passes": true,
      "notes": "Added input mode toggle (Paste Text / Record Audio), recording UI, and transcribe edge function."
    }
  ]
}
